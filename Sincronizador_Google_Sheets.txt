// 1. Abre tu hoja de Google Sheets.
// 2. Ve al men칰 superior: "Extensiones" > "Apps Script".
// 3. Borra todo lo que haya ah칤 y pega este c칩digo completo.
// 4. Haz clic en el 칤cono de Guardar (el disquete).
// 5. Ve a la izquierda al 칤cono del Reloj ("Desencadenadores").
// 6. Abajo a la derecha haz clic en "+ A침adir desencadenador".
//    - Funci칩n a ejecutar: SincronizarProtesisAFirebase
//    - Tipo de evento: Al editarse.
//    - Guardar y aceptar los permisos de Google.

const PROJECT_ID = 'cajacx-test';
const API_KEY = 'AIzaSyCbw4diu0XCH2L22x2HF9Mxh1dOUcbg'; // Tu clave de Firebase

/**
 * Agregamos un men칰 a la hoja de Google Sheets para facilitar el backup manual
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('游 Control COAT')
      .addItem('Sincronizar hacia Web (Manual)', 'SincronizarProtesisAFirebase')
      .addItem('Importar Backup desde Web', 'ImportarDesdeFirebase')
      .addToUi();
}

/**
 * Funci칩n que informa al usuario solo si hay una interfaz abierta
 */
function informar(mensaje) {
  try {
    const ui = SpreadsheetApp.getUi();
    if (ui) ui.alert(mensaje);
  } catch (e) {
    Logger.log(mensaje);
  }
}

/**
 * Funci칩n que env칤a datos nuevos del Excel a la Web (Firestore)
 */
function SincronizarProtesisAFirebase() {
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Pr칩tesis');
  if (!sheet) sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const idSincronizado = row[11]; // Columna L
    if (idSincronizado) continue;
    
    const paciente = row[3];
    if (!paciente) continue;
    
    const docData = {
      fecha_pedido: formatearFecha(row[0]) || formatearFecha(new Date()),
      empresa: (row[1] || '').toString().toUpperCase(),
      medico: (row[2] || '').toString(),
      paciente: paciente.toString().toUpperCase(),
      dni: (row[4] || '').toString(),
      tubos: parseInt(row[5]) || 1,
      recibe: (row[6] || '').toString(),
      notas: (row[7] || '').toString(),
      devolucion: (row[8] || "NO").toString(),
      fecha_colocacion: formatearFecha(row[9]) || null,
      fecha_entrega: formatearFecha(row[10]) || null
    };
    
    const firebaseId = enviarAFirestore(docData);
    if (firebaseId) {
      sheet.getRange(i + 1, 12).setValue(firebaseId);
    }
  }
}

/**
 * NUEVA FUNCI칍N: BI-DIRECCIONAL (Firestore -> Excel)
 * Trae todo lo que hay en la web y lo guarda/actualiza en el Excel como Backup.
 */
function ImportarDesdeFirebase() {
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Pr칩tesis');
  if (!sheet) sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];

  const url = "https://firestore.googleapis.com/v1/projects/" + PROJECT_ID + "/databases/(default)/documents/protesis?pageSize=500&key=" + API_KEY;
  
  try {
    const response = UrlFetchApp.fetch(url, { method: 'get', muteHttpExceptions: true });
    const text = response.getContentText();
    const json = JSON.parse(text);
    
    if (response.getResponseCode() !== 200) {
      return informar("Error de conexi칩n: " + text);
    }

    if (!json.documents) return informar("No se encontraron documentos en la web.");

    const data = sheet.getDataRange().getValues();
    const existingIds = {};
    data.forEach((row, index) => {
      if (row[11]) existingIds[row[11]] = index + 1; // Columna L
    });

    let nuevos = 0;
    let actualizados = 0;

    json.documents.forEach(doc => {
      const f = doc.fields;
      const parts = doc.name.split('/');
      const fbId = parts[parts.length - 1];

      const rowData = [
        f.fecha_pedido ? f.fecha_pedido.stringValue : '',
        f.empresa ? f.empresa.stringValue : '',
        f.medico ? f.medico.stringValue : '',
        f.paciente ? f.paciente.stringValue : '',
        f.dni ? f.dni.stringValue : '',
        f.tubos ? f.tubos.integerValue : '1',
        f.recibe ? f.recibe.stringValue : '',
        f.notas ? f.notas.stringValue : '',
        f.devolucion ? f.devolucion.stringValue : 'NO',
        f.fecha_colocacion ? f.fecha_colocacion.stringValue : '',
        f.fecha_entrega ? f.fecha_entrega.stringValue : '',
        fbId
      ];

      if (existingIds[fbId]) {
        sheet.getRange(existingIds[fbId], 1, 1, 12).setValues([rowData]);
        actualizados++;
      } else {
        sheet.appendRow(rowData);
        nuevos++;
      }
    });

    informar("Backup finalizado.\n\nRegistros nuevos: " + nuevos + "\nRegistros actualizados: " + actualizados);
  } catch (e) {
    informar("Error cr칤tico: " + e.message);
  }
}

function formatearFecha(fecha) {
  if (!fecha) return '';
  if (fecha instanceof Date) {
    const yyyy = fecha.getFullYear();
    const mm = String(fecha.getMonth() + 1).padStart(2, '0');
    const dd = String(fecha.getDate()).padStart(2, '0');
    return yyyy + "-" + mm + "-" + dd;
  }
  return fecha.toString();
}

function enviarAFirestore(docData) {
  const firestorePayload = {
    fields: {
      fecha_pedido: { stringValue: docData.fecha_pedido },
      empresa: { stringValue: docData.empresa },
      medico: { stringValue: docData.medico },
      paciente: { stringValue: docData.paciente },
      dni: { stringValue: docData.dni },
      tubos: { integerValue: docData.tubos.toString() },
      recibe: { stringValue: docData.recibe },
      notas: { stringValue: docData.notas },
      devolucion: { stringValue: docData.devolucion },
      fecha_colocacion: docData.fecha_colocacion ? { stringValue: docData.fecha_colocacion } : { nullValue: null },
      fecha_entrega: docData.fecha_entrega ? { stringValue: docData.fecha_entrega } : { nullValue: null }
    }
  };

  const url = "https://firestore.googleapis.com/v1/projects/" + PROJECT_ID + "/databases/(default)/documents/protesis?key=" + API_KEY;
  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(firestorePayload),
    muteHttpExceptions: true
  };
  
  try {
    const response = UrlFetchApp.fetch(url, options);
    const json = JSON.parse(response.getContentText());
    if (response.getResponseCode() === 200 && json.name) {
      const partes = json.name.split('/');
      return partes[partes.length - 1];
    }
    return null;
  } catch(e) {
    return null;
  }
}
