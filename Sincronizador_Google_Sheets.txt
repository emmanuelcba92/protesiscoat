/**
 * CONFIGURACIÃ“N DE SEGURIDAD (CON CUENTA DE SERVICIO)
 * --------------------------------------------------
 * Para que este script funcione con las nuevas reglas, usamos la "Cuenta de Servicio".
 * Copia los datos de tu archivo 'serviceAccountKey.json' aquÃ­ abajo:
 */
const SERVICE_ACCOUNT = {
  "client_email": "firebase-adminsdk-fbsvc@cajacx-test.iam.gserviceaccount.com",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDtMx0Hum/p6QbI\ns7mlub/vu1mNxTxfgrCZBvuKRja41FgMdKlb270n0WKBPYryV+0RgZng7mIgZ60N\n4tALFhpDqEO+TpLqxwyZrwpWZm1qtlNxzxCkaBzM4xSjgyBpgBeRuj8WDV3y19BB\nEfSXcs+qd00OAqgDy36clOCMRcJ3NxIISOKt6+8+Wq1l3UD6oDxSlzHtB0CiJZQQ\njZHo6UumDfa9cI+q13qhG++xoCHY6QF9iL1ojHANejAwLr65CLGDtyv1ruriRX8r\n7I8nPdzbBR2Xu1fGw4t2TgOwFtStdd9ab1WHbObVdfvg/TXYw8lfT//VbO2hX220\ny+7RtobvAgMBAAECggEAUxMIwtEoKwtDJf3UMlfJAkRijAWdLHJQOXg5lucaeUdd\ngxdEzXg7Wnu5/Tu5s0DaNbxnUWEMGv9Um71pUciu8C05dKh+Sh3mqtikTThYb/xl\nY0G7OWmBVLzfWJkvO+Px3UcWmzmZQtkVBgUs3fIHC1P3N8X0ZEfcEykNL/OqtSd2\n2/TNyW0au7N28dX4tRp5xAVGQzYpCfN3aLfADnJDcAhPNkyVe7qPTI/FSPJtakBh\nzTYMP4hdgk0OgJF5PogrpdDZv0ut1Tlt2zxYLkEjiCKJshir5OVjdu2WwcQnb7YH\nTnrAgaC6nW7g7JSmZSZQjsVqGZyCzqPAYZ4tez83QQKBgQD3DSRc0ersATfLPMdF\nHBzp2MsIUoiMvNivavOHA4jCnV1KIOibEXpYDa5g0NLAX2wtqNmYAs3xkLj4C+ao\n2Cqt3rR1Q4X7SNSTkQIJVYTF+db8VovuWjxsr3pX8mibNNKL6na+BC58rttKx6uD\nHJsoRmPJLa1LxtsmLYqINXqcYQKBgQD1yp5lpXRpzllcGGmpE/UKu5FQn4rppyvX\nlZsxoQPxR6RKnMdaUvyJYo3CWnncgma7eghMwwi1Cp4T4wNfXe9VTCiPuZVMm3Ic\n4kLUTxfFgKupTkZmElb04bHB5gAe0QiE2gbEi4+9w8UgNp+Xs6nGl/J18xTwSAkA\nqBhx7+5lTwKBgQDLES1bclykQtgGoV22K8aEXON+YsDE1hFSFxo3VytZtJnS7bvk\ngnhK2mwEPoGNCKJV4Z2BuoRnVCsGEFo3XP+vzQgN/0Oo6hN5fE7tNzMcvCD/Z3A7\nqkZSm+Z3VdSwBrotsbqKs8s2R1APZpJPAftzHnC1E2uHhtvpxLNDBJpU4QKBgQCx\nMFFB+6XRhMVco+i/z7hN9WvLkEgnKrFrZ9mKTIY4ESp5802varXNILQLEQhak9MV\ngeKr28nSIYZV1cifnmsjtZRkECh2InWAJwiAX0hGw/x8QAZ2HPB89psbqgAaNx0K\nENbiJ64G4jOghmBEj2tr1CwhJYzJr1R2GbgNoybb9wKBgQCcd+TVz72fSCKroWm2\nMiP2oOsxg/butoQN+gnHY4LgRnSWDPSvU7sLMLzef4w7byz80fLGXR2v7WSe02fC\n+9Pc9jCxiYulekwCgr6BbGwWW38anEOH5YH7G/W+WnkCBcvF/orlh93ijibRwjyR\nL3vUZeq17+kgL114Sq1QMr12pQ==\n-----END PRIVATE KEY-----\n",
  "project_id": "cajacx-test"
};

/**
 * Agregamos un menÃº a la hoja de Google Sheets para facilitar el backup manual
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ðŸš€ Control COAT')
      .addItem('Sincronizar hacia Web (Manual)', 'SincronizarProtesisAFirebase')
      .addItem('Importar Backup desde Web', 'ImportarDesdeFirebase')
      .addToUi();
}

function informar(mensaje) {
  try {
    const ui = SpreadsheetApp.getUi();
    if (ui) ui.alert(mensaje);
  } catch (e) {
    Logger.log(mensaje);
  }
}

/**
 * OBTIENE UN TOKEN DE ACCESO (OAUTH2)
 * Esto es necesario para "saltarse" las reglas de seguridad usando la cuenta de servicio.
 */
function getAccessToken() {
  const header = JSON.stringify({
    "alg": "RS256",
    "typ": "JWT"
  });
  
  const now = Math.floor(Date.now() / 1000);
  const payload = JSON.stringify({
    "iss": SERVICE_ACCOUNT.client_email,
    "scope": "https://www.googleapis.com/auth/datastore",
    "aud": "https://oauth2.googleapis.com/token",
    "exp": now + 3600,
    "iat": now
  });
  
  const signatureInput = Utilities.base64EncodeWebSafe(header) + "." + Utilities.base64EncodeWebSafe(payload);
  const signature = Utilities.computeRsaSha256Signature(signatureInput, SERVICE_ACCOUNT.private_key);
  const jwt = signatureInput + "." + Utilities.base64EncodeWebSafe(signature);
  
  const response = UrlFetchApp.fetch("https://oauth2.googleapis.com/token", {
    method: "post",
    payload: {
      grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
      assertion: jwt
    }
  });
  
  return JSON.parse(response.getContentText()).access_token;
}

function SincronizarProtesisAFirebase() {
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('PrÃ³tesis');
  if (!sheet) sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  
  const data = sheet.getDataRange().getValues();
  const token = getAccessToken();
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const idSincronizado = row[11];
    if (idSincronizado) continue;
    
    const paciente = row[3];
    if (!paciente) continue;
    
    const docData = {
      fecha_pedido: formatearFecha(row[0]) || formatearFecha(new Date()),
      empresa: (row[1] || '').toString().toUpperCase(),
      medico: (row[2] || '').toString(),
      paciente: paciente.toString().toUpperCase(),
      dni: (row[4] || '').toString(),
      tubos: parseInt(row[5]) || 1,
      recibe: (row[6] || '').toString(),
      notas: (row[7] || '').toString(),
      devolucion: (row[8] || "NO").toString(),
      fecha_colocacion: formatearFecha(row[9]) || null,
      fecha_entrega: formatearFecha(row[10]) || null
    };
    
    const firebaseId = enviarAFirestore(docData, token);
    if (firebaseId) {
      sheet.getRange(i + 1, 12).setValue(firebaseId);
    }
  }
}

function ImportarDesdeFirebase() {
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('PrÃ³tesis');
  if (!sheet) sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];

  const token = getAccessToken();
  const url = `https://firestore.googleapis.com/v1/projects/${SERVICE_ACCOUNT.project_id}/databases/(default)/documents/protesis?pageSize=500`;
  
  try {
    const response = UrlFetchApp.fetch(url, { 
      method: 'get', 
      headers: { "Authorization": "Bearer " + token },
      muteHttpExceptions: true 
    });
    const text = response.getContentText();
    const json = JSON.parse(text);
    
    if (response.getResponseCode() !== 200) {
      return informar("Error de conexiÃ³n: " + text);
    }

    if (!json.documents) return informar("No se encontraron documentos en la web.");

    const data = sheet.getDataRange().getValues();
    const existingIds = {};
    data.forEach((row, index) => {
      if (row[11]) existingIds[row[11]] = index + 1;
    });

    let nuevos = 0;
    let actualizados = 0;

    json.documents.forEach(doc => {
      const f = doc.fields;
      const parts = doc.name.split('/');
      const fbId = parts[parts.length - 1];

      const rowData = [
        f.fecha_pedido ? f.fecha_pedido.stringValue : '',
        f.empresa ? f.empresa.stringValue : '',
        f.medico ? f.medico.stringValue : '',
        f.paciente ? f.paciente.stringValue : '',
        f.dni ? f.dni.stringValue : '',
        f.tubos ? f.tubos.integerValue : '1',
        f.recibe ? f.recibe.stringValue : '',
        f.notas ? f.notas.stringValue : '',
        f.devolucion ? f.devolucion.stringValue : 'NO',
        f.fecha_colocacion ? f.fecha_colocacion.stringValue : '',
        f.fecha_entrega ? f.fecha_entrega.stringValue : '',
        fbId
      ];

      if (existingIds[fbId]) {
        sheet.getRange(existingIds[fbId], 1, 1, 12).setValues([rowData]);
        actualizados++;
      } else {
        sheet.appendRow(rowData);
        nuevos++;
      }
    });

    informar("Backup finalizado.\n\nRegistros nuevos: " + nuevos + "\nRegistros actualizados: " + actualizados);
  } catch (e) {
    informar("Error crÃ­tico: " + e.message);
  }
}

function formatearFecha(fecha) {
  if (!fecha) return '';
  if (fecha instanceof Date) {
    const yyyy = fecha.getFullYear();
    const mm = String(fecha.getMonth() + 1).padStart(2, '0');
    const dd = String(fecha.getDate()).padStart(2, '0');
    return yyyy + "-" + mm + "-" + dd;
  }
  return fecha.toString();
}

function enviarAFirestore(docData, token) {
  const firestorePayload = {
    fields: {
      fecha_pedido: { stringValue: docData.fecha_pedido },
      empresa: { stringValue: docData.empresa },
      medico: { stringValue: docData.medico },
      paciente: { stringValue: docData.paciente },
      dni: { stringValue: docData.dni },
      tubos: { integerValue: docData.tubos.toString() },
      recibe: { stringValue: docData.recibe },
      notas: { stringValue: docData.notas },
      devolucion: { stringValue: docData.devolucion },
      fecha_colocacion: docData.fecha_colocacion ? { stringValue: docData.fecha_colocacion } : { nullValue: null },
      fecha_entrega: docData.fecha_entrega ? { stringValue: docData.fecha_entrega } : { nullValue: null }
    }
  };

  const url = `https://firestore.googleapis.com/v1/projects/${SERVICE_ACCOUNT.project_id}/databases/(default)/documents/protesis`;
  const options = {
    method: 'post',
    contentType: 'application/json',
    headers: { "Authorization": "Bearer " + token },
    payload: JSON.stringify(firestorePayload),
    muteHttpExceptions: true
  };
  
  try {
    const response = UrlFetchApp.fetch(url, options);
    const json = JSON.parse(response.getContentText());
    if (response.getResponseCode() === 200 && json.name) {
      const partes = json.name.split('/');
      return partes[partes.length - 1];
    }
    return null;
  } catch(e) {
    return null;
  }
}
