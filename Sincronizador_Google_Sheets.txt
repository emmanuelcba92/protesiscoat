// 1. Abre tu hoja de Google Sheets.
// 2. Ve al men煤 superior: "Extensiones" > "Apps Script".
// 3. Borra todo lo que haya ah铆 y pega este c贸digo completo.
// 4. Haz clic en el 铆cono de Guardar (el disquete).
// 5. Ve a la izquierda al 铆cono del Reloj ("Desencadenadores").
// 6. Abajo a la derecha haz clic en "+ A帽adir desencadenador".
//    - Funci贸n a ejecutar: SincronizarProtesisAFirebase
//    - Tipo de evento: Al editarse.
//    - Guardar y aceptar los permisos de Google.

const PROJECT_ID = 'cajacx-test';

/**
 * Agregamos un men煤 a la hoja de Google Sheets para facilitar el backup manual
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu(' Control COAT')
      .addItem('Sincronizar hacia Web (Manual)', 'SincronizarProtesisAFirebase')
      .addItem('Importar Backup desde Web', 'ImportarDesdeFirebase')
      .addToUi();
}

/**
 * Funci贸n que env铆a datos nuevos del Excel a la Web (Firestore)
 */
function SincronizarProtesisAFirebase() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Pr贸tesis');
  if (!sheet) return SpreadsheetApp.getUi().alert("No se encontr贸 la hoja llamada 'Pr贸tesis'");
  
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const idSincronizado = row[11]; // Columna L
    if (idSincronizado) continue;
    
    const paciente = row[3];
    if (!paciente) continue;
    
    const docData = {
      fecha_pedido: formatearFecha(row[0]) || formatearFecha(new Date()),
      empresa: (row[1] || '').toString().toUpperCase(),
      medico: (row[2] || '').toString(),
      paciente: paciente.toString().toUpperCase(),
      dni: (row[4] || '').toString(),
      tubos: parseInt(row[5]) || 1,
      recibe: (row[6] || '').toString(),
      notas: (row[7] || '').toString(),
      devolucion: (row[8] || "NO").toString(),
      fecha_colocacion: formatearFecha(row[9]) || null,
      fecha_entrega: formatearFecha(row[10]) || null
    };
    
    const firebaseId = enviarAFirestore(docData);
    if (firebaseId) {
      sheet.getRange(i + 1, 12).setValue(firebaseId);
    }
  }
}

/**
 * NUEVA FUNCIN: BI-DIRECCIONAL (Firestore -> Excel)
 * Trae todo lo que hay en la web y lo guarda/actualiza en el Excel como Backup.
 */
function ImportarDesdeFirebase() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Pr贸tesis');
  if (!sheet) return SpreadsheetApp.getUi().alert("No se encontr贸 la hoja llamada 'Pr贸tesis'");

  const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/protesis?pageSize=500`;
  const response = UrlFetchApp.fetch(url, { method: 'get', muteHttpExceptions: true });
  const json = JSON.parse(response.getContentText());
  
  if (!json.documents) return SpreadsheetApp.getUi().alert("No se encontraron documentos en la web.");

  const data = sheet.getDataRange().getValues();
  const existingIds = {};
  data.forEach((row, index) => {
    if (row[11]) existingIds[row[11]] = index + 1; // Columna L
  });

  let nuevos = 0;
  let actualizados = 0;

  json.documents.forEach(doc => {
    const f = doc.fields;
    const parts = doc.name.split('/');
    const fbId = parts[parts.length - 1];

    const rowData = [
      f.fecha_pedido ? f.fecha_pedido.stringValue : '',
      f.empresa ? f.empresa.stringValue : '',
      f.medico ? f.medico.stringValue : '',
      f.paciente ? f.paciente.stringValue : '',
      f.dni ? f.dni.stringValue : '',
      f.tubos ? f.tubos.integerValue : '1',
      f.recibe ? f.recibe.stringValue : '',
      f.notas ? f.notas.stringValue : '',
      f.devolucion ? f.devolucion.stringValue : 'NO',
      f.fecha_colocacion ? f.fecha_colocacion.stringValue : '',
      f.fecha_entrega ? f.fecha_entrega.stringValue : '',
      fbId
    ];

    if (existingIds[fbId]) {
      // Si ya existe, actualizamos la fila (Excepto si el usuario lo edit贸 en Sheets manualmente y no quiere sobrescribir)
      sheet.getRange(existingIds[fbId], 1, 1, 12).setValues([rowData]);
      actualizados++;
    } else {
      // Si no existe, lo agregamos al final
      sheet.appendRow(rowData);
      nuevos++;
    }
  });

  SpreadsheetApp.getUi().alert(`Backup finalizado.\n\nRegistros nuevos agregados: ${nuevos}\nRegistros actualizados: ${actualizados}`);
}

function formatearFecha(fecha) {
  if (!fecha) return '';
  if (fecha instanceof Date) {
    const yyyy = fecha.getFullYear();
    const mm = String(fecha.getMonth() + 1).padStart(2, '0');
    const dd = String(fecha.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }
  return fecha.toString();
}

function enviarAFirestore(docData) {
  const firestorePayload = {
    fields: {
      fecha_pedido: { stringValue: docData.fecha_pedido },
      empresa: { stringValue: docData.empresa },
      medico: { stringValue: docData.medico },
      paciente: { stringValue: docData.paciente },
      dni: { stringValue: docData.dni },
      tubos: { integerValue: docData.tubos.toString() },
      recibe: { stringValue: docData.recibe },
      notas: { stringValue: docData.notas },
      devolucion: { stringValue: docData.devolucion },
      fecha_colocacion: docData.fecha_colocacion ? { stringValue: docData.fecha_colocacion } : { nullValue: null },
      fecha_entrega: docData.fecha_entrega ? { stringValue: docData.fecha_entrega } : { nullValue: null }
    }
  };

  const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/protesis`;
  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(firestorePayload),
    muteHttpExceptions: true
  };
  
  try {
    const response = UrlFetchApp.fetch(url, options);
    const json = JSON.parse(response.getContentText());
    if (response.getResponseCode() === 200 && json.name) {
      const partes = json.name.split('/');
      return partes[partes.length - 1];
    }
    return null;
  } catch(e) {
    return null;
  }
}
