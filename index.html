<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Prótesis</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase Compat SDKs para simplicidad sin build tools -->
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

    <!-- EmailJS CDN para notificaciones por email -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function () {
            // Inicialización simple
            emailjs.init("ZI8efqGOOC1hJM07-");
        })();
    </script>

    <!-- Configuración Custom de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        turquesa: '#0D9488',
                    }
                }
            }
        }
    </script>
    <style>
        /* Clase utilitaria para mostrar el modal de forma fluida */
        .modal-active {
            display: flex !important;
        }

        /* Estilos para Impresión */
        @media print {
            body * {
                visibility: hidden;
            }

            #section-to-print,
            #section-to-print * {
                visibility: visible;
            }

            #section-to-print {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
            }

            .print-page {
                padding: 1cm;
                min-height: 29.7cm;
                page-break-after: always;
                color: black !important;
            }

            .no-print {
                display: none !important;
            }
        }

        #section-to-print {
            display: none;
        }

        @media print {
            #section-to-print {
                display: block;
            }
        }
    </style>
</head>

<body class="bg-gray-100 font-sans text-gray-800 min-h-screen">

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Encabezado -->
        <header
            class="flex flex-col sm:flex-row justify-between items-center mb-8 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">Control de Prótesis</h1>
            <div class="flex gap-8">
                <div class="text-center">
                    <p class="text-sm text-gray-500 uppercase tracking-wider font-semibold">Total</p>
                    <p class="text-3xl font-bold text-turquesa" id="contador-total">0</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500 uppercase tracking-wider font-semibold">Pendientes</p>
                    <p class="text-3xl font-bold text-amber-500" id="contador-pendientes">0</p>
                </div>
            </div>
        </header>

        <!-- Acciones (Buscador y Botón) -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div class="flex flex-col sm:flex-row w-full sm:w-2/3 gap-4">
                <div class="relative w-full sm:w-1/2">
                    <input type="text" id="searchInput" placeholder="Buscar paciente, médico o DNI..."
                        class="w-full pl-4 pr-4 py-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent transition shadow-sm">
                </div>
                <div class="relative w-full sm:w-1/2">
                    <select id="statusFilter"
                        class="w-full pl-4 pr-4 py-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent transition shadow-sm bg-white font-medium text-gray-700">
                        <option value="PENDIENTES">Vista: Pendientes (Predeterminado)</option>
                        <option value="LISTOS">Vista: Certificados Listos</option>
                        <option value="PARA_DEVOLVER">Vista: Para Devolver</option>
                        <option value="FINALIZADOS">Vista: Historial (Entregados/Devueltos)</option>
                        <option value="TODOS">Vista: Todos los registros</option>
                    </select>
                </div>
            </div>
            <button onclick="openModal()"
                class="w-full sm:w-auto bg-turquesa hover:bg-teal-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200">
                + Nueva Prótesis
            </button>
        </div>

        <!-- Tabla -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-4 text-center">
                                <input type="checkbox" id="selectAll"
                                    class="w-4 h-4 text-turquesa rounded border-gray-300 focus:ring-turquesa">
                            </th>
                            <th scope="col"
                                class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                Fecha</th>
                            <th scope="col"
                                class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                Empresa / Médico</th>
                            <th scope="col"
                                class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                Paciente</th>
                            <th scope="col"
                                class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">DNI
                            </th>
                            <th scope="col"
                                class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                Tubos</th>
                            <th scope="col"
                                class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                Devol.</th>
                            <th scope="col"
                                class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                Colocación</th>
                            <th scope="col"
                                class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Filas de datos -->
                        <tr>
                            <td colspan="8" class="px-6 py-8 text-center text-gray-500">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Carga -->
    <div id="protesisModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden justify-center items-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden transform transition-all">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800">Cargar Nueva Prótesis</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-700 transition">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form id="protesisForm" class="p-6" onsubmit="handleFormSubmit(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Fecha de Pedido</label>
                        <input type="date" id="fechaPedido" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Empresa</label>
                        <input type="text" id="empresa" required placeholder="Ej: ImplantTech" list="empresasList"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                        <datalist id="empresasList">
                            <option value="Angiocor"></option>
                            <option value="General Healt"></option>
                            <option value="Primordial Salud"></option>
                            <option value="Traumacor"></option>
                            <option value="Asismed"></option>
                            <option value="Implacor"></option>
                            <option value="Leonardo N. Espósito"></option>
                            <option value="Optica Crillón"></option>
                            <option value="Optica Santa Lucia"></option>
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Médico</label>
                        <input type="text" id="medico" required placeholder="Dr. / Dra." list="medicosList"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                        <datalist id="medicosList">
                            <option value="Dr. Bruera"></option>
                            <option value="Dr. Curet"></option>
                            <option value="Dr. Escalera"></option>
                            <option value="Dr. Hoyos"></option>
                            <option value="Dr. Jasin"></option>
                            <option value="Dr. Paredes"></option>
                            <option value="Dr. Sapag"></option>
                            <option value="Dr. Zernotti"></option>
                            <option value="Dra. Carranza"></option>
                            <option value="Dra. Ojeda"></option>
                            <option value="Dra. Romani"></option>
                            <option value="Dra. Teilletchea"></option>
                            <option value="Dra. Valeriani"></option>
                            <option value="Dra. Venier"></option>
                            <option value="Dra. Zalazar"></option>
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">DNI Paciente</label>
                        <input type="text" id="dni" placeholder="Sin puntos (Opcional)"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Nombre del Paciente</label>
                        <input type="text" id="paciente" required placeholder="Apellidos y Nombres"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Cantidad Tubos</label>
                        <select id="tubos" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent bg-white">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Quién recibe</label>
                        <input type="text" id="recibe" placeholder="Nombre de quien recibe"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Fecha Colocación (Dejar vacío si
                            está pendiente)</label>
                        <input type="date" id="fechaColocacion"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Notas / Observaciones</label>
                        <textarea id="notas" rows="2" placeholder="Información adicional del pedido..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent"></textarea>
                    </div>
                </div>

                <div class="mt-8 flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeModal()"
                        class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition duration-150">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="px-5 py-2.5 bg-turquesa text-white font-medium rounded-lg hover:bg-teal-700 shadow-md transition duration-150"
                        id="btnGuardar">
                        Guardar Prótesis
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edición -->
    <div id="editModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden justify-center items-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden transform transition-all">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800">Actualizar Estado</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-700 transition">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form id="editForm" class="p-6" onsubmit="handleEditSubmit(event)">
                <input type="hidden" id="editId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">DNI Paciente</label>
                        <input type="text" id="editDni" placeholder="Sin puntos"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Nueva Fecha Colocación</label>
                        <input type="date" id="editFechaColocacion"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Borrar si se suspende/reprograma</p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Estado (Tubos /
                            Certificado)</label>
                        <select id="editDevolucion" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent bg-white">
                            <option value="NO">NO (Material en clínica)</option>
                            <option value="CERTIFICADO_LISTO">CERTIFICADO LISTO (En clínica)</option>
                            <option value="CERTIFICADO_ENTREGADO">CERTIFICADO ENTREGADO</option>
                            <option value="DEVUELTO">PARA DEVOLVER (Material sobrante)</option>
                            <option value="MATERIAL_DEVUELTO">MATERIAL DEVUELTO</option>
                        </select>
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeEditModal()"
                        class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition duration-150">Cancelar</button>
                    <button type="submit"
                        class="px-5 py-2.5 bg-turquesa text-white font-medium rounded-lg hover:bg-teal-700 shadow-md transition duration-150"
                        id="btnGuardarEdit">
                        Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lógica de la Aplicación -->
    <script>
        /**
         * 1. CONFIGURACIÓN DE FIREBASE
         * REEMPLAZA ESTE OBJETO CON TUS CREDENCIALES DE FIREBASE
         */
        const firebaseConfig = {
            apiKey: "AIzaSyCBm4dIubUOXCHZLE2xxZHF9MKh1dGUcBg",
            authDomain: "cajacx-test.firebaseapp.com",
            projectId: "cajacx-test",
            storageBucket: "cajacx-test.firebasestorage.app",
            messagingSenderId: "930859241568",
            appId: "1:930859241568:web:b0073b71a921e5affff305"
        };

        let db = null;
        // Validación básica para evitar crash si no se han puesto las keys
        if (firebaseConfig.apiKey !== 'TU_API_KEY') {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        }

        // Estado local de los datos para la tabla
        let protesisData = [];

        // Inicialización al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            // Setear la fecha de hoy por defecto en el form
            document.getElementById('fechaPedido').valueAsDate = new Date();

            // Traer datos de la base de datos
            fetchData();

            // Event listener buscador en tiempo real
            document.getElementById('searchInput').addEventListener('input', () => renderTable());

            // Event listener filtro de estado
            document.getElementById('statusFilter').addEventListener('change', () => renderTable());

            // Lógica para autocompletar con <Enter> y prevenir envío accidental del formulario
            const inputsConDatalist = document.querySelectorAll('input[list]');
            inputsConDatalist.forEach(input => {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Evitar envío del formulario

                        const listId = this.getAttribute('list');
                        const dataList = document.getElementById(listId);
                        const term = this.value.toLowerCase().trim();

                        if (term && dataList) {
                            const options = Array.from(dataList.options);
                            // Buscar primera coincidencia que empiece con lo escrito
                            let match = options.find(opt => opt.value.toLowerCase().startsWith(term));

                            // Si no, buscar que al menos contenga el texto
                            if (!match) {
                                match = options.find(opt => opt.value.toLowerCase().includes(term));
                            }

                            // Autocompletar el campo con el nombre completo
                            if (match) {
                                this.value = match.value;
                            }
                        }

                        // Opcional: enfocar el siguiente cambpo para acelerar la carga
                        if (this.id === 'empresa') document.getElementById('medico').focus();
                        else if (this.id === 'medico') document.getElementById('dni').focus();
                    }
                });
            });

            // Opcional: evitar también que Enter envíe el form en otros inputs 
            // a menos que sea el botón de Submit
            document.querySelectorAll('#protesisForm input:not([list])').forEach(input => {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') e.preventDefault();
                });
            });
        });

        // ==========================
        // MANEJO DE MODAL
        // ==========================
        const modal = document.getElementById('protesisModal');
        const form = document.getElementById('protesisForm');

        function openModal() {
            form.reset();
            document.getElementById('fechaPedido').valueAsDate = new Date();
            document.getElementById('tubos').value = '1';
            modal.classList.add('modal-active');
        }

        function closeModal() {
            modal.classList.remove('modal-active');
        }

        // ==========================
        // PERSISTENCIA DE DATOS (FIREBASE)
        // ==========================

        /**
         * Traer los datos desde Firestore
         */
        async function fetchData() {
            if (!db) {
                console.warn("⚠️ Firebase no configurado. Mostrando datos de prueba locales.");
                protesisData = [
                    { id: '1', fecha_pedido: '2026-02-20', empresa: 'ImplantTech', medico: 'Dr. Pérez', paciente: 'Juan Gómez', dni: '12345678', tubos: 2, devolucion: 'NO', fecha_colocacion: null, notas: 'Faltan tornillos' },
                    { id: '2', fecha_pedido: '2026-02-18', empresa: 'BioMed', medico: 'Dra. López', paciente: 'María Silva', dni: '87654321', tubos: 1, devolucion: 'SI', fecha_colocacion: '2026-02-19', notas: '' }
                ];
                renderTable();
                updateCounters();
                return;
            }

            try {
                // Asumiendo que la colección en Firestore se llama "protesis"
                const snapshot = await db.collection('protesis').orderBy('fecha_pedido', 'desc').get();

                protesisData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                renderTable();
                updateCounters();
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Hubo un error al cargar los datos. Verifica la consola y las reglas de seguridad de Firestore.');
            }
        }

        /**
         * Insertar un nuevo registro en Firestore
         */
        async function saveData(newData) {
            const btnGuardar = document.getElementById('btnGuardar');
            const textoOriginal = btnGuardar.innerText;
            btnGuardar.innerText = 'Guardando...';
            btnGuardar.disabled = true;

            try {
                if (!db) {
                    // Simulación de guardado para la prueba visual
                    newData.id = Date.now().toString();
                    protesisData.unshift(newData);

                    setTimeout(() => {
                        renderTable();
                        updateCounters();
                        closeModal();
                        btnGuardar.innerText = textoOriginal;
                        btnGuardar.disabled = false;
                    }, 500);
                    return;
                }

                const docRef = await db.collection('protesis').add(newData);

                // Agregar el registro recién guardado al estado local con su nuevo ID autogenerado
                newData.id = docRef.id;
                protesisData.unshift(newData);

                // Enviar notificación por email
                try {
                    // Enviamos los datos asegurando que coincidan con las llaves {{}} de tu plantilla
                    await emailjs.send("service_o4o0u4r", "template_7xhq6tq", {
                        paciente: newData.paciente,
                        dni: newData.dni,
                        medico: newData.medico,
                        empresa: newData.empresa,
                        tubos: newData.tubos,
                        recibe: newData.recibe || 'N/A',
                        notas: newData.notas || 'Sin notas'
                    }, "ZI8efqGOOC1hJM07-"); // Pasamos la llave pública también aquí por seguridad
                    console.log("✅ Email de notificación enviado correctamente.");
                } catch (emailError) {
                    console.error('❌ Error EmailJS:', emailError);
                    // Si el servidor nos dio un mensaje de error, lo mostramos en la consola
                    if (emailError.text) {
                        console.error('Detalle técnico del error:', emailError.text);
                    }
                }

                renderTable();
                updateCounters();
                closeModal();
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Hubo un error al guardar la prótesis. Verifica la consola y las reglas de seguridad de Firestore.');
            } finally {
                btnGuardar.innerText = textoOriginal;
                btnGuardar.disabled = false;
            }
        }

        // ==========================
        // EVENTOS DEL DOM
        // ==========================
        async function handleFormSubmit(e) {
            e.preventDefault();

            // Construir objeto con los datos del form
            const newData = {
                fecha_pedido: document.getElementById('fechaPedido').value,
                empresa: document.getElementById('empresa').value,
                medico: document.getElementById('medico').value,
                dni: document.getElementById('dni').value,
                paciente: document.getElementById('paciente').value,
                tubos: parseInt(document.getElementById('tubos').value),
                devolucion: 'NO',
                recibe: document.getElementById('recibe').value || '',
                fecha_colocacion: document.getElementById('fechaColocacion').value || null, // null si está vacío
                notas: document.getElementById('notas').value
            };

            await saveData(newData);
        }

        // ==========================
        // EDICIÓN Y ELIMINACIÓN
        // ==========================
        const modalEdit = document.getElementById('editModal');
        const formEdit = document.getElementById('editForm');

        function openEditModal(id, fechaColocacion, devolucion, dni) {
            document.getElementById('editId').value = id;
            document.getElementById('editFechaColocacion').value = fechaColocacion;
            document.getElementById('editDevolucion').value = devolucion === 'SI' ? 'DEVUELTO' : devolucion;
            document.getElementById('editDni').value = dni || '';
            modalEdit.classList.add('modal-active');
        }

        function closeEditModal() {
            modalEdit.classList.remove('modal-active');
        }

        async function handleEditSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const nuevaFecha = document.getElementById('editFechaColocacion').value || null;
            const nuevaDevolucion = document.getElementById('editDevolucion').value;
            const nuevoDni = document.getElementById('editDni').value || '';

            const btn = document.getElementById('btnGuardarEdit');
            const txtOriginal = btn.innerText;
            btn.innerText = 'Actualizando...';
            btn.disabled = true;

            try {
                if (db) {
                    await db.collection('protesis').doc(id).update({
                        fecha_colocacion: nuevaFecha,
                        devolucion: nuevaDevolucion,
                        dni: nuevoDni
                    });
                }

                // Actualizar estado local
                const idx = protesisData.findIndex(p => p.id === id);
                if (idx !== -1) {
                    protesisData[idx].fecha_colocacion = nuevaFecha;
                    protesisData[idx].devolucion = nuevaDevolucion;
                    protesisData[idx].dni = nuevoDni;
                }

                renderTable();
                updateCounters();
                closeEditModal();
            } catch (error) {
                console.error("Error al actualizar:", error);
                alert("Hubo un error al actualizar.");
            } finally {
                btn.innerText = txtOriginal;
                btn.disabled = false;
            }
        }

        async function deleteData(id) {
            if (!confirm("¿Estás seguro de que deseas eliminar este pedido? Esta acción no se puede deshacer.")) return;

            try {
                if (db) {
                    await db.collection('protesis').doc(id).delete();
                }

                // Actualizar estado local
                protesisData = protesisData.filter(p => p.id !== id);

                renderTable();
                updateCounters();
            } catch (error) {
                console.error("Error al eliminar:", error);
                alert("Hubo un error al eliminar.");
            }
        }

        // ==========================
        // RENDERIZADO VISUAL
        // ==========================

        // Helper para mostrar fechas de AAAA-MM-DD a DD/MM/AAAA sin offset de zona horaria
        // Barra de acciones masivas
        const bulkActionBar = document.createElement('div');
        bulkActionBar.id = 'bulkActionBar';
        bulkActionBar.className = "fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-6 z-[60] transform translate-y-32 transition-transform duration-300 border border-gray-700";
        bulkActionBar.innerHTML = `
            <span class="text-sm font-medium"><span id="selectedCount">0</span> seleccionados</span>
            <div class="h-6 w-px bg-gray-700"></div>
            <button onclick="handleBulkPrint('CERTIFICADO')" class="flex items-center gap-2 bg-turquesa hover:bg-teal-600 px-4 py-2 rounded-lg text-sm font-bold transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                Constancia Certificado
            </button>
            <button onclick="handleBulkPrint('DEVOLUCION')" class="flex items-center gap-2 bg-amber-600 hover:bg-amber-700 px-4 py-2 rounded-lg text-sm font-bold transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3m9 14V5a2 2 0 00-2-2H6a2 2 0 00-2 2v16l4-2 4 2 4-2 4 2z"></path></svg>
                Constancia Devolución
            </button>
        `;
        document.body.appendChild(bulkActionBar);

        function updateBulkBar() {
            const selected = document.querySelectorAll('.item-checkbox:checked').length;
            const bar = document.getElementById('bulkActionBar');
            document.getElementById('selectedCount').innerText = selected;

            if (selected > 0) {
                bar.classList.remove('translate-y-32');
            } else {
                bar.classList.add('translate-y-32');
            }
        }

        async function handleBulkPrint(type) {
            const selectedChecks = document.querySelectorAll('.item-checkbox:checked');
            const selectedIds = Array.from(selectedChecks).map(cb => cb.value);
            const items = protesisData.filter(p => selectedIds.includes(p.id));

            if (items.length === 0) return;

            // Agrupar por empresa
            const itemsByCompany = items.reduce((acc, item) => {
                if (!acc[item.empresa]) acc[item.empresa] = [];
                acc[item.empresa].push(item);
                return acc;
            }, {});

            const printContainer = document.getElementById('section-to-print');
            printContainer.innerHTML = '';

            const hoy = new Date();
            const fechaString = `Córdoba, ${hoy.getDate()} de ${["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"][hoy.getMonth()]} de ${hoy.getFullYear()}`;

            for (const [empresa, listaPacientes] of Object.entries(itemsByCompany)) {
                const page = document.createElement('div');
                page.className = 'print-page';

                const titulo = type === 'CERTIFICADO' ? 'Constancia de entrega de certificado de implante' : 'Constancia de devolución de material';
                const parrafo = type === 'CERTIFICADO'
                    ? `Por la presente se hace entrega a la empresa <strong>${empresa}</strong> de los siguientes certificados, los cuales fueron oportunamente solicitados para el paciente:`
                    : `Por la presente se hace entrega a la empresa <strong>${empresa}</strong> de los siguientes materiales, los cuales fueron oportunamente solicitados para el paciente:`;

                const footerLabel = type === 'CERTIFICADO' ? 'Recibe:' : 'Se reciben: <br><br> Recibe:';

                page.innerHTML = `
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <img src="logo coat.png" style="max-height: 80px; margin-bottom: 0.5rem;">
                    </div>
                    
                    <div style="text-align: right; margin-bottom: 3rem; font-size: 1.1rem;">${fechaString}</div>
                    
                    <h2 style="text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 3rem; text-decoration: underline;">${titulo}</h2>
                    
                    <p style="margin-bottom: 1.5rem; line-height: 1.6; font-size: 1.1rem;">${parrafo}</p>
                    
                    <div style="margin-bottom: 4rem;">
                        ${listaPacientes.map(p => `
                            <div style="margin-bottom: 0.8rem; font-size: 1.1rem;">
                                • <strong>${p.paciente.toUpperCase()}</strong> ${p.dni ? `(DNI: ${p.dni})` : ''}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 5rem; font-size: 1.1rem;">
                        <p style="margin-bottom: 3rem;">${footerLabel} ___________________________</p>
                        <p>Firma: ___________________________</p>
                    </div>
                `;
                printContainer.appendChild(page);
            }

            window.print();

            // Preguntar si desea actualizar el estado masivamente
            const nuevoEstado = type === 'CERTIFICADO' ? 'CERTIFICADO_ENTREGADO' : 'MATERIAL_DEVUELTO';
            if (confirm(`¿Deseas marcar los ${items.length} registros seleccionados como "${nuevoEstado.replace('_', ' ')}"?`)) {

                for (const id of selectedIds) {
                    try {
                        if (db) {
                            await db.collection('protesis').doc(id).update({ devolucion: nuevoEstado });
                        }
                        const idx = protesisData.findIndex(p => p.id === id);
                        if (idx !== -1) protesisData[idx].devolucion = nuevoEstado;
                    } catch (e) {
                        console.error("Error actualizando masivamente:", e);
                    }
                }

                // Limpiar selección
                document.getElementById('selectAll').checked = false;
                renderTable();
                updateCounters();
            }
        }

        function formatearFecha(fechaString) {
            if (!fechaString) return '-';
            const partes = fechaString.split('-');
            if (partes.length === 3) {
                return `${partes[2]}/${partes[1]}/${partes[0]}`;
            }
            return fechaString;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            // Filtrado de datos por el buscador y estado
            const filteredData = protesisData.filter(item => {
                // Filtro de estado
                let statusMatch = true;
                if (statusFilter === 'PENDIENTES') {
                    statusMatch = item.devolucion === 'NO' || !item.devolucion;
                } else if (statusFilter === 'LISTOS') {
                    statusMatch = item.devolucion === 'CERTIFICADO_LISTO';
                } else if (statusFilter === 'PARA_DEVOLVER') {
                    statusMatch = item.devolucion === 'DEVUELTO';
                } else if (statusFilter === 'FINALIZADOS') {
                    statusMatch = item.devolucion === 'CERTIFICADO_ENTREGADO' || item.devolucion === 'MATERIAL_DEVUELTO';
                }

                if (!statusMatch) return false;

                // Filtro de búsqueda textual
                if (!searchTerm) return true;

                return (item.paciente && item.paciente.toLowerCase().includes(searchTerm)) ||
                    (item.medico && item.medico.toLowerCase().includes(searchTerm)) ||
                    (item.dni && item.dni.toString().includes(searchTerm)) ||
                    (item.empresa && item.empresa.toLowerCase().includes(searchTerm));
            });

            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500 font-medium">No se encontraron registros.</td></tr>`;
                return;
            }

            filteredData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition duration-150 group";

                // Si el item está seleccionado (mantener estado visual si ya estaba)
                const isSelected = document.querySelector(`.item-checkbox[value="${item.id}"]`)?.checked;

                const isPendiente = !item.fecha_colocacion;

                // Badge visual para devolución
                let devolucionBadge = '<span class="px-2.5 py-1 inline-flex text-xs leading-4 font-bold rounded-md bg-gray-100 text-gray-700">NO</span>';
                if (item.devolucion === 'CERTIFICADO_LISTO') {
                    devolucionBadge = '<span class="px-2.5 py-1 inline-flex text-xs leading-4 font-bold rounded-md bg-amber-100 text-amber-700">CERTIF. LISTO</span>';
                } else if (item.devolucion === 'CERTIFICADO_ENTREGADO') {
                    devolucionBadge = '<span class="px-2.5 py-1 inline-flex text-xs leading-4 font-bold rounded-md bg-blue-100 text-blue-800">CERTIF. ENTREGADO</span>';
                } else if (item.devolucion === 'DEVUELTO' || item.devolucion === 'SI') {
                    devolucionBadge = '<span class="px-2.5 py-1 inline-flex text-xs leading-4 font-bold rounded-md bg-rose-100 text-rose-700">PARA DEVOLVER</span>';
                } else if (item.devolucion === 'MATERIAL_DEVUELTO') {
                    devolucionBadge = '<span class="px-2.5 py-1 inline-flex text-xs leading-4 font-bold rounded-md bg-emerald-100 text-emerald-800">MAT. DEVUELTO</span>';
                }

                tr.innerHTML = `
                    <td class="px-4 py-4 text-center">
                        <input type="checkbox" class="item-checkbox w-4 h-4 text-turquesa rounded border-gray-300 focus:ring-turquesa" value="${item.id}" ${isSelected ? 'checked' : ''} onchange="updateBulkBar()">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">${formatearFecha(item.fecha_pedido)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        <div class="font-bold text-gray-800">${item.empresa}</div>
                        <div class="text-gray-500 text-xs mt-0.5">${item.medico}</div>
                        ${item.recibe ? `<div class="text-turquesa font-semibold text-xs mt-1">Recibe: ${item.recibe}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800">${item.paciente}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.dni}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-center font-medium">${item.tubos}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">${devolucionBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${isPendiente
                        ? `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-bold bg-amber-50 text-amber-600 border border-amber-200">
                                 <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span> Pendiente
                               </span>`
                        : `<span class="text-gray-800 font-medium">${formatearFecha(item.fecha_colocacion)}</span>`}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium flex gap-2">
                        <button class="text-turquesa hover:text-teal-900 bg-teal-50 hover:bg-teal-100 px-3 py-1.5 rounded-md transition disabled:opacity-50" 
                                onclick="alert('Notas: ${item.notas || 'No hay notas registradas para este pedido.'}')"
                                ${!item.notas ? 'disabled title="Sin notas"' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                        <button class="text-amber-600 hover:text-amber-900 bg-amber-50 hover:bg-amber-100 px-3 py-1.5 rounded-md transition" 
                                onclick="openEditModal('${item.id}', '${item.fecha_colocacion || ''}', '${item.devolucion}', '${item.dni || ''}')" title="Editar Estado">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button class="text-rose-600 hover:text-rose-900 bg-rose-50 hover:bg-rose-100 px-3 py-1.5 rounded-md transition" 
                                onclick="deleteData('${item.id}')" title="Eliminar">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Event listener para el botón "Seleccionar todos"
        document.addEventListener('change', (e) => {
            if (e.target.id === 'selectAll') {
                const checked = e.target.checked;
                document.querySelectorAll('.item-checkbox').forEach(cb => {
                    cb.checked = checked;
                });
                updateBulkBar();
            }
        });

        function updateCounters() {
            // Total
            document.getElementById('contador-total').innerText = protesisData.length;
            // Pendientes (no tienen fecha de colocación)
            const pendientes = protesisData.filter(item => !item.fecha_colocacion).length;
            document.getElementById('contador-pendientes').innerText = pendientes;
        }

        /**
         * Función de utilidad para cargar datos masivos desde la consola si es necesario
         * Uso: cargarDatosIniciales()
         */
        async function cargarDatosIniciales() {
            const data = [
                { fecha_pedido: '2025-11-27', empresa: 'general healt', medico: 'Dra Venier', paciente: 'PISTELLI MYRIAN', tubos: 1, recibe: 'JESICA' },
                { fecha_pedido: '2025-12-12', empresa: 'general healt', medico: 'Dra Romani', paciente: 'Sanchez Bautista', tubos: 2, recibe: 'Norma' },
                { fecha_pedido: '2025-12-12', empresa: 'general healt', medico: 'Dra Romani', paciente: 'Poggio Amelie', tubos: 2, recibe: 'Norma' },
                { fecha_pedido: '2026-01-12', empresa: 'general healt', medico: 'Dra Venier', paciente: 'arguello alma', tubos: 2, recibe: 'adriana' },
                { fecha_pedido: '2026-01-12', empresa: 'general healt', medico: 'Dra Romani', paciente: 'sanchez claudia', tubos: 1, recibe: 'adriana' },
                { fecha_pedido: '2026-01-14', empresa: 'angiocor', medico: 'Dra Venier', paciente: 'montefusco maria', tubos: 2, recibe: 'adriana' },
                { fecha_pedido: '2026-04-19', empresa: 'OPTICA CRILLON', medico: 'Dra Venier', paciente: 'DIAZ JAMES NEYMAR', tubos: 2, recibe: 'JESICA' },
                { fecha_pedido: '2026-01-29', empresa: 'optica santa lucia', medico: 'Dra Venier', paciente: 'garnica brunatto enr', tubos: 2, recibe: 'jesica' },
                { fecha_pedido: '2026-01-30', empresa: 'angiocor', medico: 'Dr Paredes', paciente: 'ibarra vera lucia', tubos: 1, recibe: 'jesica' },
                { fecha_pedido: '2026-02-04', empresa: 'angiocor', medico: 'Dra Valeriani', paciente: 'pesce herrera', tubos: 2, recibe: 'adriana' },
                { fecha_pedido: '2026-02-05', empresa: 'asismed', medico: 'Dra Romani', paciente: 'leguizamon enrique', tubos: 2, recibe: 'jesica' }
            ];

            if (!confirm(`¿Deseas cargar ${data.length} registros automáticamente?`)) return;

            console.log("Iniciando carga masiva...");
            for (const item of data) {
                const fullItem = {
                    ...item,
                    dni: '',
                    devolucion: 'NO',
                    fecha_colocacion: null,
                    notas: 'Carga masiva inicial'
                };

                try {
                    if (db) {
                        await db.collection('protesis').add(fullItem);
                        console.log(`✅ Cargado: ${item.paciente}`);
                    }
                } catch (e) {
                    console.error(`❌ Error con ${item.paciente}:`, e);
                }
            }
            alert("Carga masiva finalizada. La página se recargará.");
            location.reload();
        }
    </script>

    <!-- Sección oculta para impresión -->
    <div id="section-to-print"></div>
</body>

</html>