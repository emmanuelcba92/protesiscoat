<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Pr√≥tesis</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase eliminados del frontend: la seguridad ahora est√° en el Backend (Node.js) -->
    <!-- EmailJS eliminado del frontend: los env√≠os los realiza Nodemailer (Node.js) -->

    <!-- SheetJS (Para Exportar a Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Configuraci√≥n Custom de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        turquesa: '#0D9488',
                    }
                }
            }
        }
    </script>
    <style>
        /* Clase utilitaria para mostrar el modal de forma fluida */
        .modal-active {
            display: flex !important;
        }

        /* Estilos para Impresi√≥n */
        @media print {
            body * {
                visibility: hidden;
            }

            #section-to-print,
            #section-to-print * {
                visibility: visible;
            }

            #section-to-print {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
            }

            .print-page {
                padding: 1cm;
                min-height: 29.7cm;
                page-break-after: always;
                color: black !important;
            }

            .print-page:last-child {
                page-break-after: auto !important;
            }

            .no-print {
                display: none !important;
            }
        }

        #section-to-print {
            display: none;
        }

        @media print {
            #section-to-print {
                display: block;
            }

            input.force-uppercase {
                text-transform: uppercase;
            }
        }

        /* Forzar may√∫sculas visualmente en el input y en la tabla */
        .uppercase-text {
            text-transform: uppercase;
        }

        /* Scrollbar styling for narrow desktop */
        .scrollbar-thin::-webkit-scrollbar {
            height: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans text-gray-800 min-h-screen">

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Encabezado -->
        <header
            class="flex flex-col sm:flex-row justify-between items-center mb-8 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">Control de Pr√≥tesis</h1>
            <div class="flex gap-8">
                <div class="text-center">
                    <p class="text-sm text-gray-500 uppercase tracking-wider font-semibold">Total</p>
                    <p class="text-3xl font-bold text-turquesa" id="contador-total">0</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500 uppercase tracking-wider font-semibold">Pendientes</p>
                    <p class="text-3xl font-bold text-amber-500" id="contador-pendientes">0</p>
                </div>
            </div>
        </header>

        <!-- Acciones (Buscador y Bot√≥n) -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div class="flex flex-col sm:flex-row w-full sm:w-2/3 gap-4">
                <div class="relative w-full sm:w-1/2">
                    <input type="text" id="searchInput" placeholder="Buscar paciente, m√©dico o DNI..."
                        class="w-full pl-4 pr-4 py-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent transition shadow-sm">
                </div>
                <div class="relative w-full sm:w-1/2">
                    <select id="statusFilter"
                        class="w-full pl-4 pr-4 py-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent transition shadow-sm bg-white font-medium text-gray-700">
                        <option value="PENDIENTES">Vista: Pendientes (Predeterminado)</option>
                        <option value="LISTOS">Vista: Certificados Listos</option>
                        <option value="PARA_DEVOLVER">Vista: Para Devolver</option>
                        <option value="FINALIZADOS">Vista: Historial (Entregados/Devueltos)</option>
                        <option value="TODOS">Vista: Todos los registros</option>
                    </select>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                <button onclick="exportarExcel()"
                    class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200 flex justify-center items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Exportar Excel
                </button>
                <button onclick="openModal()"
                    class="w-full sm:w-auto bg-turquesa hover:bg-teal-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200">
                    + Nueva Pr√≥tesis
                </button>
            </div>
        </div>

        <!-- Tabla Desktop / Vista Mosaico Mobile -->
        <div id="content-container">
            <!-- Vista Tabla (Desktop) -->
            <div class="hidden md:block bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-4 text-center">
                                    <input type="checkbox" id="selectAll"
                                        class="w-4 h-4 text-turquesa rounded border-gray-300 focus:ring-turquesa">
                                </th>
                                <th scope="col"
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Fecha recepci√≥n</th>
                                <th scope="col"
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Empresa / M√©dico</th>
                                <th scope="col"
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Paciente</th>
                                <th scope="col"
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    DNI
                                </th>
                                <th scope="col"
                                    class="px-4 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Tubos</th>
                                <th scope="col"
                                    class="px-4 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Devol.</th>
                                <th scope="col"
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Colocaci√≥n</th>
                                <th scope="col"
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Filas de datos -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Vista Mosaico (Mobile) -->
            <div id="mobileBody" class="md:hidden grid grid-cols-1 gap-4">
                <!-- Tarjetas de datos -->
            </div>

            <div id="loadingState" class="bg-white p-12 text-center text-gray-500 rounded-xl border border-gray-100"
                style="display: none;">
                No hay registros para mostrar.
            </div>
        </div>
    </div>

    <!-- Modal de Carga -->
    <div id="protesisModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden justify-center items-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden transform transition-all">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800">Cargar Nueva Pr√≥tesis</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-700 transition">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form id="protesisForm" class="p-6" onsubmit="handleFormSubmit(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Fecha de recepci√≥n</label>
                        <input type="date" id="fechaPedido" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Empresa</label>
                        <input type="text" id="empresa" required placeholder="Ej: IMPLANTTECH" list="empresasList"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent uppercase-text">
                        <datalist id="empresasList">
                            <option value="Angiocor"></option>
                            <option value="General Healt"></option>
                            <option value="Primordial Salud"></option>
                            <option value="Traumacor"></option>
                            <option value="Asismed"></option>
                            <option value="Implacor"></option>
                            <option value="Leonardo N. Esp√≥sito"></option>
                            <option value="Optica Crill√≥n"></option>
                            <option value="Optica Santa Lucia"></option>
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">M√©dico</label>
                        <input type="text" id="medico" required placeholder="Dr. / Dra." list="medicosList"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                        <datalist id="medicosList">
                            <option value="Dr. Bruera"></option>
                            <option value="Dr. Curet"></option>
                            <option value="Dr. Escalera"></option>
                            <option value="Dr. Hoyos"></option>
                            <option value="Dr. Jasin"></option>
                            <option value="Dr. Paredes"></option>
                            <option value="Dr. Sapag"></option>
                            <option value="Dr. Zernotti"></option>
                            <option value="Dra. Carranza"></option>
                            <option value="Dra. Ojeda"></option>
                            <option value="Dra. Romani"></option>
                            <option value="Dra. Teilletchea"></option>
                            <option value="Dra. Valeriani"></option>
                            <option value="Dra. Venier"></option>
                            <option value="Dra. Zalazar"></option>
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">DNI Paciente</label>
                        <input type="text" id="dni" placeholder="Sin puntos (Opcional)"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Nombre del Paciente</label>
                        <input type="text" id="paciente" required placeholder="APELLIDOS Y NOMBRES"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent uppercase-text">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Cantidad Tubos</label>
                        <select id="tubos" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent bg-white">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Qui√©n recibe</label>
                        <input type="text" id="recibe" placeholder="Nombre de quien recibe"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Fecha Colocaci√≥n (Dejar vac√≠o si
                            est√° pendiente)</label>
                        <input type="date" id="fechaColocacion"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Notas / Observaciones</label>
                        <textarea id="notas" rows="2" placeholder="Informaci√≥n adicional del pedido..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent"></textarea>
                    </div>
                </div>

                <div class="mt-8 flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeModal()"
                        class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition duration-150">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="px-5 py-2.5 bg-turquesa text-white font-medium rounded-lg hover:bg-teal-700 shadow-md transition duration-150"
                        id="btnGuardar">
                        Guardar Pr√≥tesis
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edici√≥n -->
    <div id="editModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden justify-center items-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden transform transition-all">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800">Actualizar Estado</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-700 transition">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form id="editForm" class="p-6" onsubmit="handleEditSubmit(event)">
                <input type="hidden" id="editId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">DNI Paciente</label>
                        <input type="text" id="editDni" placeholder="Sin puntos"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Nueva Fecha Colocaci√≥n</label>
                        <input type="date" id="editFechaColocacion"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Borrar si se suspende/reprograma</p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Estado (Tubos /
                            Certificado)</label>
                        <select id="editDevolucion" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent bg-white">
                            <option value="NO">NO (Material en cl√≠nica)</option>
                            <option value="CERTIFICADO_LISTO">CERTIFICADO LISTO (En cl√≠nica)</option>
                            <option value="CERTIFICADO_ENTREGADO">CERTIFICADO ENTREGADO</option>
                            <option value="DEVUELTO">PARA DEVOLVER (Material sobrante)</option>
                            <option value="MATERIAL_DEVUELTO">MATERIAL DEVUELTO</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Fecha de
                            Entrega/Devoluci√≥n</label>
                        <input type="date" id="editFechaEntrega"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-turquesa focus:border-transparent">
                        <p class="text-[10px] text-gray-500 mt-1 leading-tight">Define cu√°ndo se entreg√≥ el certificado
                            o se devolvi√≥ el material. Si se deja en blanco, ser√° PENDIENTE o tomar√° la fecha de
                            impresi√≥n masiva.</p>
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeEditModal()"
                        class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition duration-150">Cancelar</button>
                    <button type="submit"
                        class="px-5 py-2.5 bg-turquesa text-white font-medium rounded-lg hover:bg-teal-700 shadow-md transition duration-150"
                        id="btnGuardarEdit">
                        Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- L√≥gica de la Aplicaci√≥n -->
    <script>
        /**
         * URL DEL BACKEND
         * Cambiar esta URL cuando se suba el backend a un servidor real (ej. Render, Railway)
         */
        const API_URL = "http://localhost:3000/api/protesis";

        // Estado local de los datos para la tabla
        let protesisData = [];

        // Inicializaci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            // Setear la fecha de hoy por defecto en el form
            document.getElementById('fechaPedido').valueAsDate = new Date();

            // Traer datos de la base de datos
            fetchData();

            // Event listener buscador en tiempo real
            document.getElementById('searchInput').addEventListener('input', () => renderTable());

            // Event listener filtro de estado
            document.getElementById('statusFilter').addEventListener('change', () => renderTable());

            // L√≥gica para autocompletar con <Enter> y prevenir env√≠o accidental del formulario
            const inputsConDatalist = document.querySelectorAll('input[list]');
            inputsConDatalist.forEach(input => {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Evitar env√≠o del formulario

                        const listId = this.getAttribute('list');
                        const dataList = document.getElementById(listId);
                        const term = this.value.toLowerCase().trim();

                        if (term && dataList) {
                            const options = Array.from(dataList.options);
                            // Buscar primera coincidencia que empiece con lo escrito
                            let match = options.find(opt => opt.value.toLowerCase().startsWith(term));

                            // Si no, buscar que al menos contenga el texto
                            if (!match) {
                                match = options.find(opt => opt.value.toLowerCase().includes(term));
                            }

                            // Autocompletar el campo con el nombre completo
                            if (match) {
                                this.value = match.value.toUpperCase();
                            }
                        }

                        // Opcional: enfocar el siguiente cambpo para acelerar la carga
                        if (this.id === 'empresa') {
                            this.value = this.value.toUpperCase();
                            document.getElementById('medico').focus();
                        }
                        else if (this.id === 'medico') document.getElementById('dni').focus();
                    }
                });

                // Forzar may√∫sculas mientras escriben
                input.addEventListener('input', function () {
                    if (this.id === 'empresa' || this.id === 'paciente') {
                        this.value = this.value.toUpperCase();
                    }
                });
            });

            // Forzar may√∫sculas en paciente (que no tiene list)
            const inputPaciente = document.getElementById('paciente');
            inputPaciente.addEventListener('input', function () {
                this.value = this.value.toUpperCase();
            });

            // Opcional: evitar tambi√©n que Enter env√≠e el form en otros inputs 
            // a menos que sea el bot√≥n de Submit
            document.querySelectorAll('#protesisForm input:not([list])').forEach(input => {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') e.preventDefault();
                });
                // Forzar may√∫sculas si es el campo de paciente
                if (input.id === 'paciente') {
                    input.addEventListener('input', function () {
                        this.value = this.value.toUpperCase();
                    });
                }
            });
        });

        // ==========================
        // MANEJO DE MODAL
        // ==========================
        const modal = document.getElementById('protesisModal');
        const form = document.getElementById('protesisForm');

        function openModal() {
            form.reset();
            document.getElementById('fechaPedido').valueAsDate = new Date();
            document.getElementById('tubos').value = '1';
            modal.classList.add('modal-active');
        }

        function closeModal() {
            modal.classList.remove('modal-active');
        }

        // ==========================
        // PERSISTENCIA DE DATOS (FIREBASE)
        // ==========================

        /**
         * Traer los datos a trav√©s del Backend
         */
        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Error en la respuesta del servidor");

                protesisData = await response.json();

                const loadingState = document.getElementById('loadingState');
                if (loadingState) loadingState.style.display = 'none';

                renderTable();
                updateCounters();
            } catch (error) {
                console.error('Error fetching data:', error);

                // Si falla el backend, mostramos datos de prueba locales para evitar que la UI quede en blanco
                console.warn("‚ö†Ô∏è Backend no disponible. Mostrando datos locales de prueba.");
                protesisData = [
                    { id: '1', fecha_pedido: '2026-02-20', empresa: 'ImplantTech', medico: 'Dr. P√©rez', paciente: 'Juan G√≥mez', dni: '12345678', tubos: 2, devolucion: 'NO', fecha_colocacion: null, notas: 'Faltan tornillos' },
                    { id: '2', fecha_pedido: '2026-02-18', empresa: 'BioMed', medico: 'Dra. L√≥pez', paciente: 'Mar√≠a Silva', dni: '87654321', tubos: 1, devolucion: 'SI', fecha_colocacion: '2026-02-19', notas: '' }
                ];
                renderTable();
                updateCounters();
            }
        }

        /**
         * Insertar un nuevo registro v√≠a Backend
         */
        async function saveData(newData) {
            const btnGuardar = document.getElementById('btnGuardar');
            const textoOriginal = btnGuardar.innerText;
            btnGuardar.innerText = 'Guardando...';
            btnGuardar.disabled = true;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newData)
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const savedRecord = await response.json();

                // Agregarlo a la tabla local al principio
                protesisData.unshift(savedRecord);

                renderTable();
                updateCounters();
                closeModal();
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Hubo un error al guardar la pr√≥tesis en el servidor.');
            } finally {
                btnGuardar.innerText = textoOriginal;
                btnGuardar.disabled = false;
            }
        }

        // ==========================
        // EVENTOS DEL DOM
        // ==========================
        async function handleFormSubmit(e) {
            e.preventDefault();

            // Construir objeto con los datos del form
            const newData = {
                fecha_pedido: document.getElementById('fechaPedido').value,
                empresa: document.getElementById('empresa').value,
                medico: document.getElementById('medico').value,
                dni: document.getElementById('dni').value,
                paciente: document.getElementById('paciente').value,
                tubos: parseInt(document.getElementById('tubos').value),
                devolucion: 'NO',
                recibe: document.getElementById('recibe').value || '',
                fecha_colocacion: document.getElementById('fechaColocacion').value || null, // null si est√° vac√≠o
                notas: document.getElementById('notas').value
            };

            await saveData(newData);
        }

        // ==========================
        // EDICI√ìN Y ELIMINACI√ìN
        // ==========================
        const modalEdit = document.getElementById('editModal');
        const formEdit = document.getElementById('editForm');

        function openEditModal(id, fechaColocacion, devolucion, dni, fechaEntrega) {
            document.getElementById('editId').value = id;
            document.getElementById('editFechaColocacion').value = fechaColocacion || '';
            document.getElementById('editDevolucion').value = devolucion === 'SI' ? 'DEVUELTO' : devolucion;
            document.getElementById('editDni').value = dni || '';
            document.getElementById('editFechaEntrega').value = fechaEntrega || '';
            modalEdit.classList.add('modal-active');
        }

        function closeEditModal() {
            modalEdit.classList.remove('modal-active');
        }

        async function handleEditSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const nuevaFecha = document.getElementById('editFechaColocacion').value || null;
            const nuevaDevolucion = document.getElementById('editDevolucion').value;
            const nuevoDni = document.getElementById('editDni').value || '';
            const nuevaFechaEntrega = document.getElementById('editFechaEntrega').value || null;

            const btn = document.getElementById('btnGuardarEdit');
            const txtOriginal = btn.innerText;
            btn.innerText = 'Actualizando...';
            btn.disabled = true;

            const updateData = {
                fecha_colocacion: nuevaFecha,
                devolucion: nuevaDevolucion,
                dni: nuevoDni,
                fecha_entrega: nuevaFechaEntrega
            };

            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) throw new Error("Fallo en servidor al actualizar.");

                // Actualizar estado local
                const idx = protesisData.findIndex(p => p.id === id);
                if (idx !== -1) {
                    protesisData[idx].fecha_colocacion = nuevaFecha;
                    protesisData[idx].devolucion = nuevaDevolucion;
                    protesisData[idx].dni = nuevoDni;
                    protesisData[idx].fecha_entrega = nuevaFechaEntrega;
                }

                renderTable();
                updateCounters();
                closeEditModal();
            } catch (error) {
                console.error("Error al actualizar:", error);
                alert("Hubo un error al actualizar a trav√©s del servidor.");
            } finally {
                btn.innerText = txtOriginal;
                btn.disabled = false;
            }
        }

        async function deleteData(id) {
            const pin = prompt("Por razones de seguridad, ingresa el PIN para eliminar este registro:");
            // Esta verificaci√≥n local es solo primera capa. El Backend validar√° el pin final.
            if (!pin) {
                return;
            }

            if (!confirm("¬øEst√°s seguro de que deseas eliminar este pedido? Esta acci√≥n no se puede deshacer.")) return;

            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin: pin }) // Enviamos el PIN en el Body
                });

                const responseData = await response.json();

                if (!response.ok) {
                    alert(responseData.error || "No autorizado para borrar (PIN Incorrecto Server)");
                    return;
                }

                // Actualizar estado local quitando el registro de la UI
                protesisData = protesisData.filter(p => p.id !== id);

                renderTable();
                updateCounters();
            } catch (error) {
                console.error("Error al eliminar:", error);
                alert("Hubo un error con el servidor al intentar eliminar.");
            }
        }

        // ==========================
        // RENDERIZADO VISUAL
        // ==========================

        // Helper para mostrar fechas de AAAA-MM-DD a DD/MM/AAAA sin offset de zona horaria
        // Barra de acciones masivas
        const bulkActionBar = document.createElement('div');
        bulkActionBar.id = 'bulkActionBar';
        bulkActionBar.className = "fixed bottom-4 sm:bottom-8 left-4 right-4 sm:left-1/2 sm:-translate-x-1/2 sm:w-auto bg-gray-900/95 backdrop-blur text-white px-4 sm:px-6 py-3 sm:py-4 rounded-xl sm:rounded-2xl shadow-2xl flex flex-row items-center justify-between sm:justify-center gap-3 sm:gap-6 z-[60] transform translate-y-64 transition-all duration-300 border border-gray-700/50";
        bulkActionBar.innerHTML = `
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-0 sm:gap-2">
                <span id="selectedCount" class="text-xl sm:text-sm font-black text-turquesa sm:text-white leading-none">0</span>
                <span class="text-[9px] sm:text-sm uppercase sm:normal-case font-bold sm:font-medium text-gray-400 sm:text-white tracking-widest sm:tracking-normal">Seleccionados</span>
            </div>
            <div class="h-8 w-px bg-gray-700 hidden sm:block"></div>
            <div class="flex flex-col sm:flex-row items-center gap-2">
                <div class="relative group">
                    <input type="date" id="bulkFechaImpresion" 
                        class="bg-gray-800 text-white text-xs px-3 py-2 rounded border border-gray-600 focus:outline-none focus:border-turquesa transition"
                        title="Fecha de la constancia (Por defecto: Hoy)">
                    <p class="absolute -top-6 left-0 text-[10px] text-gray-400 whitespace-nowrap opacity-0 group-hover:opacity-100 transition pointer-events-none">Fecha Constancia (Opcional)</p>
                </div>
                <button onclick="handleBulkPrint('CERTIFICADO')" class="flex items-center justify-center gap-2 bg-turquesa hover:bg-teal-600 p-2 sm:px-4 sm:py-2 rounded-lg text-sm font-bold transition shadow-lg active:scale-95 w-full sm:w-auto" title="Constancia Certificado">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    <span class="hidden sm:inline">Constancia Certificado</span>
                </button>
                <button onclick="handleBulkPrint('DEVOLUCION')" class="flex items-center justify-center gap-2 bg-amber-600 hover:bg-amber-700 p-2 sm:px-4 sm:py-2 rounded-lg text-sm font-bold transition shadow-lg active:scale-95 w-full sm:w-auto" title="Constancia Devoluci√≥n">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3m9 14V5a2 2 0 00-2-2H6a2 2 0 00-2 2v16l4-2 4 2 4-2 4 2z"></path></svg>
                    <span class="hidden sm:inline">Constancia Devoluci√≥n</span>
                </button>
            </div>
        `;
        document.body.appendChild(bulkActionBar);

        function updateBulkBar() {
            const selected = document.querySelectorAll('.item-checkbox:checked').length;
            const bar = document.getElementById('bulkActionBar');
            document.getElementById('selectedCount').innerText = selected;

            if (selected > 0) {
                bar.classList.remove('translate-y-64');
            } else {
                bar.classList.add('translate-y-64');
            }
        }

        async function handleBulkPrint(type) {
            const selectedChecks = document.querySelectorAll('.item-checkbox:checked');
            const selectedIds = Array.from(selectedChecks).map(cb => cb.value);
            const items = protesisData.filter(p => selectedIds.includes(p.id));

            if (items.length === 0) return;

            // Agrupar por empresa
            const itemsByCompany = items.reduce((acc, item) => {
                if (!acc[item.empresa]) acc[item.empresa] = [];
                acc[item.empresa].push(item);
                return acc;
            }, {});

            const printContainer = document.getElementById('section-to-print');
            printContainer.innerHTML = '';

            let fechaString = "";
            let fechaISO = "";
            const fechaManual = document.getElementById('bulkFechaImpresion').value;

            if (fechaManual) {
                // Si el usuario eligi√≥ una fecha manual (Ej. "2026-02-15")
                const [yyyy, mm, dd] = fechaManual.split('-');
                const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                fechaString = `C√≥rdoba, ${parseInt(dd, 10)} de ${meses[parseInt(mm, 10) - 1]} de ${yyyy}`;
                fechaISO = fechaManual;
            } else {
                // Si no eligi√≥ nada, usa hoy
                const hoy = new Date();
                const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                fechaString = `C√≥rdoba, ${hoy.getDate()} de ${meses[hoy.getMonth()]} de ${hoy.getFullYear()}`;

                // Formato YYYY-MM-DD para guardar en BD considerando Local Time
                const yyyy = hoy.getFullYear();
                const mm = String(hoy.getMonth() + 1).padStart(2, '0');
                const dd = String(hoy.getDate()).padStart(2, '0');
                fechaISO = `${yyyy}-${mm}-${dd}`;
            }

            for (const [empresa, listaPacientes] of Object.entries(itemsByCompany)) {
                const page = document.createElement('div');
                page.className = 'print-page';

                const titulo = type === 'CERTIFICADO' ? 'Constancia de entrega de certificado de implante' : 'Constancia de devoluci√≥n de material';
                const parrafo = type === 'CERTIFICADO'
                    ? `Por la presente se hace entrega a la empresa <strong>${empresa}</strong> de los siguientes certificados, los cuales fueron oportunamente solicitados para el paciente:`
                    : `Por la presente se hace entrega a la empresa <strong>${empresa}</strong> de los siguientes materiales, los cuales fueron oportunamente solicitados para el paciente:`;

                const footerLabel = type === 'CERTIFICADO' ? 'Recibe:' : 'Se reciben: <br><br> Recibe:';

                page.innerHTML = `
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <img src="logo coat.png" style="max-height: 80px; margin-bottom: 0.5rem;">
                    </div>
                    
                    <div style="text-align: right; margin-bottom: 3rem; font-size: 1.1rem;">${fechaString}</div>
                    
                    <h2 style="text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 3rem; text-decoration: underline;">${titulo}</h2>
                    
                    <p style="margin-bottom: 1.5rem; line-height: 1.6; font-size: 1.1rem;">${parrafo}</p>
                    
                    <div style="margin-bottom: 4rem;">
                        ${listaPacientes.map(p => `
                            <div style="margin-bottom: 0.8rem; font-size: 1.1rem; border-bottom: 1px dashed #eee; padding-bottom: 5px;">
                                ‚Ä¢ <span contenteditable="true"><strong>${p.paciente.toUpperCase()}</strong></span> 
                                <span contenteditable="true">${p.dni ? `(DNI: ${p.dni})` : '(DNI: ________)'}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div style="background: #fff9c4; padding: 10px; border-radius: 5px; margin-bottom: 2rem; border: 1px solid #fbc02d; font-size: 0.9rem;" class="no-print">
                        <strong>üí° Tip:</strong> Puedes hacer clic sobre el nombre o el DNI arriba para editarlos directamente si necesitas corregir algo antes de imprimir.
                    </div>
                    
                    <div style="margin-top: 5rem; font-size: 1.1rem;">
                        <p style="margin-bottom: 3rem;">${footerLabel} ___________________________</p>
                        <p>Firma: ___________________________</p>
                    </div>
                `;
                printContainer.appendChild(page);
            }

            window.print();

            // Preguntar si desea actualizar el estado masivamente
            const nuevoEstado = type === 'CERTIFICADO' ? 'CERTIFICADO_ENTREGADO' : 'MATERIAL_DEVUELTO';
            if (confirm(`¬øDeseas marcar los ${items.length} registros seleccionados como "${nuevoEstado.replace('_', ' ')}" con fecha ${formatearFecha(fechaISO)}?`)) {

                try {
                    // Llamar endpoint masivo 
                    const response = await fetch(`${API_URL}/bulk-update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ids: selectedIds,
                            updateData: {
                                devolucion: nuevoEstado,
                                fecha_entrega: fechaISO
                            }
                        })
                    });

                    if (response.ok) {
                        // Actualizar UI Local
                        for (const id of selectedIds) {
                            const idx = protesisData.findIndex(p => p.id === id);
                            if (idx !== -1) {
                                protesisData[idx].devolucion = nuevoEstado;
                                protesisData[idx].fecha_entrega = fechaISO;
                            }
                        }
                    } else {
                        throw new Error("Respuesta del servidor fall√≥ bulk update");
                    }
                } catch (e) {
                    console.error("Error actualizando masivamente en servidor:", e);
                    alert("Los datos no se pudieron actualizar masivamente en la base de datos.");
                }

                // Limpiar selecci√≥n
                document.getElementById('selectAll').checked = false;
                renderTable();
                updateCounters();
            }
        }

        function formatearFecha(fechaString) {
            if (!fechaString) return '-';
            const partes = fechaString.split('-');
            if (partes.length === 3) {
                return `${partes[2]}/${partes[1]}/${partes[0]}`;
            }
            return fechaString;
        }

        function exportarExcel() {
            if (protesisData.length === 0) {
                alert("No hay datos para exportar.");
                return;
            }

            // Mapeamos los datos al formato que queremos ver en Excel
            const datosExportar = protesisData.map(item => ({
                "Fecha recepci√≥n": formatearFecha(item.fecha_pedido),
                "Empresa": item.empresa || "",
                "M√©dico": item.medico || "",
                "Paciente": item.paciente ? item.paciente.toUpperCase() : "",
                "DNI": item.dni || "",
                "Tubos": item.tubos || 1,
                "Estado": item.devolucion === 'NO' ? 'Pendiente' : item.devolucion.replace('_', ' '),
                "Fecha Colocaci√≥n": formatearFecha(item.fecha_colocacion),
                "Fecha Entrega (Certif/Dev)": formatearFecha(item.fecha_entrega),
                "Recibe": item.recibe || "",
                "Notas": item.notas || ""
            }));

            // Creamos un libro de trabajo y una hoja
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datosExportar);

            // Ajustamos el ancho de las columnas
            ws['!cols'] = [
                { wch: 15 }, // Fecha recepci√≥n
                { wch: 20 }, // Empresa
                { wch: 20 }, // M√©dico
                { wch: 25 }, // Paciente
                { wch: 12 }, // DNI
                { wch: 8 },  // Tubos
                { wch: 20 }, // Estado
                { wch: 15 }, // Fecha Colocaci√≥n
                { wch: 15 }, // Fecha Entrega
                { wch: 20 }, // Recibe
                { wch: 30 }  // Notas
            ];

            // A√±adimos la hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, "Pr√≥tesis");

            // Generamos el archivo usando la fecha actual en el nombre del archivo
            const fechaHoy = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Control_Protesis_${fechaHoy}.xlsx`);
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const mobileBody = document.getElementById('mobileBody');
            const loadingState = document.getElementById('loadingState');

            tbody.innerHTML = '';
            mobileBody.innerHTML = '';
            if (loadingState) loadingState.style.display = 'none';

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            // Filtrado de datos por el buscador y estado
            const filteredData = protesisData.filter(item => {
                // Filtro de estado
                let statusMatch = true;
                if (statusFilter === 'PENDIENTES') {
                    statusMatch = item.devolucion === 'NO' || !item.devolucion;
                } else if (statusFilter === 'LISTOS') {
                    statusMatch = item.devolucion === 'CERTIFICADO_LISTO';
                } else if (statusFilter === 'PARA_DEVOLVER') {
                    statusMatch = item.devolucion === 'DEVUELTO';
                } else if (statusFilter === 'FINALIZADOS') {
                    statusMatch = item.devolucion === 'CERTIFICADO_ENTREGADO' || item.devolucion === 'MATERIAL_DEVUELTO';
                }

                if (!statusMatch) return false;

                // Filtro de b√∫squeda textual
                if (!searchTerm) return true;

                return (item.paciente && item.paciente.toLowerCase().includes(searchTerm)) ||
                    (item.medico && item.medico.toLowerCase().includes(searchTerm)) ||
                    (item.dni && item.dni.toString().includes(searchTerm)) ||
                    (item.empresa && item.empresa.toLowerCase().includes(searchTerm));
            });

            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="px-6 py-8 text-center text-gray-500 font-medium overflow-hidden">No se encontraron registros.</td></tr>`;
                mobileBody.innerHTML = `<div class="text-center p-8 bg-white rounded-xl border border-gray-100 text-gray-500">No hay registros para mostrar.</div>`;
                return;
            }

            filteredData.forEach(item => {
                // --- VERSION DESKTOP (TABLA) ---
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition duration-150 group";

                const isSelected = document.querySelector(`.item-checkbox[value="${item.id}"]`)?.checked;

                let badgeClass, badgeText;
                if (item.devolucion === 'CERTIFICADO_LISTO') {
                    badgeClass = 'bg-amber-100 text-amber-700'; badgeText = 'CERTIF. LISTO';
                } else if (item.devolucion === 'CERTIFICADO_ENTREGADO') {
                    badgeClass = 'bg-blue-100 text-blue-800'; badgeText = 'CERTIF. ENTREGADO';
                } else if (item.devolucion === 'DEVUELTO' || item.devolucion === 'SI') {
                    badgeClass = 'bg-rose-100 text-rose-700'; badgeText = 'PARA DEVOLVER';
                } else if (item.devolucion === 'MATERIAL_DEVUELTO') {
                    badgeClass = 'bg-emerald-100 text-emerald-800'; badgeText = 'MAT. DEVUELTO';
                } else {
                    badgeClass = 'bg-gray-100 text-gray-700'; badgeText = 'NO';
                }

                const pacienteUpper = (item.paciente || '').toUpperCase();
                const empresaUpper = (item.empresa || '').toUpperCase();

                tr.innerHTML = `
                    <td class="px-4 py-4 text-center">
                        <input type="checkbox" class="item-checkbox w-4 h-4 text-turquesa rounded border-gray-300 focus:ring-turquesa" value="${item.id}" ${isSelected ? 'checked' : ''} onchange="syncCheckboxes('${item.id}', this.checked)">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">${formatearFecha(item.fecha_pedido)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 min-w-[200px]">
                        <div class="font-bold text-gray-800 uppercase leading-tight">${empresaUpper}</div>
                        <div class="text-gray-500 text-xs mt-0.5">${item.medico}</div>
                        ${item.recibe ? `<div class="text-turquesa font-semibold text-xs mt-1">Recibe: ${item.recibe}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 uppercase">${pacienteUpper}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.dni || '-'}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 text-center font-medium">${item.tubos}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center">
                        <span class="px-2.5 py-1 inline-flex text-xs leading-4 font-bold rounded-md ${badgeClass}">${badgeText}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${item.fecha_colocacion
                        ? `<span class="text-gray-800 font-medium">${formatearFecha(item.fecha_colocacion)}</span>`
                        : (item.devolucion === 'MATERIAL_DEVUELTO'
                            ? '<span class="text-rose-500 font-bold text-xs uppercase">SUSPENDIDA / DEVUELTO</span>'
                            : (item.devolucion === 'CERTIFICADO_ENTREGADO'
                                ? '<span class="text-blue-500 font-bold text-xs uppercase">FINALIZADA</span>'
                                : `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-bold bg-amber-50 text-amber-600 border border-amber-200">
                                         <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span> PENDIENTE
                                       </span>`))
                    }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium flex gap-2">
                        <button class="text-turquesa bg-teal-50 hover:bg-teal-100 p-2 rounded-md transition" 
                                onclick="alert('Notas: ${item.notas || 'Sin notas'}\\nFecha Entrega Registrada: ${formatearFecha(item.fecha_entrega)}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                        <button class="text-amber-600 bg-amber-50 hover:bg-amber-100 p-2 rounded-md transition" 
                                onclick="openEditModal('${item.id}', '${item.fecha_colocacion || ''}', '${item.devolucion}', '${item.dni || ''}', '${item.fecha_entrega || ''}')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button class="text-rose-600 bg-rose-50 hover:bg-rose-100 p-2 rounded-md transition" 
                                onclick="deleteData('${item.id}')" title="Eliminar registro">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);

                // --- VERSION MOBILE (CARD) ---
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col gap-4 relative";
                card.innerHTML = `
                    <div class="absolute top-5 right-5">
                        <input type="checkbox" class="item-checkbox w-7 h-7 text-turquesa rounded-lg border-gray-300 focus:ring-turquesa shadow-sm" value="${item.id}" ${isSelected ? 'checked' : ''} onchange="syncCheckboxes('${item.id}', this.checked)">
                    </div>
                    <div class="flex flex-col pr-12">
                        <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Recepci√≥n: ${formatearFecha(item.fecha_pedido)}</span>
                        <h4 class="font-extrabold text-gray-800 text-lg uppercase leading-tight mt-1 break-words">${pacienteUpper}</h4>
                        <p class="text-[11px] text-gray-500 font-bold mt-1">${item.dni ? 'DNI ' + item.dni : 'SIN DNI'}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 p-3 bg-gray-50 rounded-xl">
                        <div>
                            <p class="text-[9px] text-gray-400 font-bold uppercase tracking-tighter mb-0.5">Empresa</p>
                            <p class="text-[12px] font-bold text-gray-800 uppercase leading-none">${empresaUpper}</p>
                        </div>
                        <div>
                            <p class="text-[9px] text-gray-400 font-bold uppercase tracking-tighter mb-0.5">M√©dico</p>
                            <p class="text-[12px] font-bold text-gray-800 uppercase leading-none">${item.medico}</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-end mt-1">
                        <div class="flex flex-col gap-2">
                             <div class="flex flex-col">
                                <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest mb-1">Estado</p>
                                <span class="px-3 py-1 inline-flex text-[11px] leading-4 font-bold rounded-lg ${badgeClass}">${badgeText}</span>
                            </div>
                            ${!item.fecha_colocacion && item.devolucion !== 'CERTIFICADO_ENTREGADO' && item.devolucion !== 'MATERIAL_DEVUELTO'
                        ? '<span class="text-[11px] text-amber-500 font-bold uppercase tracking-tighter animate-pulse">‚óè PENDIENTE</span>'
                        : (item.fecha_colocacion ? `<span class="text-[10px] text-gray-500 font-bold uppercase">Cirug√≠a: ${formatearFecha(item.fecha_colocacion)}</span>` : '')}
                        </div>
                        <div class="flex gap-2">
                             <button class="text-turquesa bg-teal-50 hover:bg-teal-100 p-3 rounded-2xl transition border border-teal-100 active:scale-95" onclick="alert('Notas: ${item.notas || 'Sin notas'}\\nFecha Entrega Registrada: ${formatearFecha(item.fecha_entrega)}')">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                            <button class="text-amber-600 bg-amber-50 hover:bg-amber-100 p-3 rounded-2xl transition border border-amber-100 active:scale-95" onclick="openEditModal('${item.id}', '${item.fecha_colocacion || ''}', '${item.devolucion}', '${item.dni || ''}', '${item.fecha_entrega || ''}')">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button class="text-rose-600 bg-rose-50 hover:bg-rose-100 p-3 rounded-2xl transition border border-rose-100 active:scale-95" onclick="deleteData('${item.id}')">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
                mobileBody.appendChild(card);
            });
        }

        // Event listener para el bot√≥n "Seleccionar todos"
        document.addEventListener('change', (e) => {
            if (e.target.id === 'selectAll') {
                const checked = e.target.checked;
                document.querySelectorAll('.item-checkbox').forEach(cb => {
                    cb.checked = checked;
                });
                updateBulkBar();
            }
        });

        function updateCounters() {
            // Total
            document.getElementById('contador-total').innerText = protesisData.length;

            // Pendientes: No tienen fecha de colocaci√≥n Y no han sido ni devueltos ni entregados
            const pendientes = protesisData.filter(item =>
                !item.fecha_colocacion &&
                item.devolucion !== 'CERTIFICADO_ENTREGADO' &&
                item.devolucion !== 'MATERIAL_DEVUELTO'
            ).length;

            document.getElementById('contador-pendientes').innerText = pendientes;
        }

        function syncCheckboxes(id, isChecked) {
            document.querySelectorAll(`.item-checkbox[value="${id}"]`).forEach(cb => {
                cb.checked = isChecked;
            });
            updateBulkBar();
        }

        async function cargarDatosIniciales() {
            const data = [
                { fecha_pedido: '2025-12-12', empresa: 'GENERAL HEALT', medico: 'Dra Romani', paciente: 'SANCHEZ BAUTISTA', tubos: 2 },
                { fecha_pedido: '2025-12-12', empresa: 'GENERAL HEALT', medico: 'Dra Romani', paciente: 'POGGIO AMELIE', tubos: 2 },
                { fecha_pedido: '2026-01-12', empresa: 'GENERAL HEALT', medico: 'Dra Valeriani', paciente: 'ARG√úELLO ALMA', tubos: 2 },
                { fecha_pedido: '2026-01-12', empresa: 'GENERAL HEALT', medico: 'Dra Romani', paciente: 'S√ÅNCHEZ CLAUDIA', tubos: 1 },
                { fecha_pedido: '2026-01-14', empresa: 'ANGIOCOR', medico: 'Dra Venier', paciente: 'MONTEFUSCO MAR√çA', tubos: 2 },
                { fecha_pedido: '2026-01-19', empresa: 'OPTICA CRILL√ìN', medico: 'Dra Venier', paciente: 'DIAS JAMES NEYMAR', tubos: 2 },
                { fecha_pedido: '2026-01-29', empresa: 'SANTA LUCIA', medico: 'Dra Venier', paciente: 'GARNICA BRUNATTO EMILIA', tubos: 2 },
                { fecha_pedido: '2026-01-30', empresa: 'ANGIOCOR', medico: 'Dr Paredes', paciente: 'IBARRA VERA LUCIA', tubos: 1 },
                { fecha_pedido: '2026-02-04', empresa: 'ANGIOCOR', medico: 'Dra Valeriani', paciente: 'PESCE HERRERA', tubos: 2 },
                { fecha_pedido: '2026-02-05', empresa: 'ASISMED', medico: 'Dra Romani', paciente: 'LEGUIZAMON ENRIQUE', tubos: 2 }
            ];

            if (!confirm(`¬øDeseas cargar ${data.length} registros autom√°ticamente?`)) return;

            console.log("Iniciando carga masiva...");
            for (const item of data) {
                const fullItem = {
                    recibe: '',
                    ...item,
                    dni: item.dni || '',
                    devolucion: 'NO',
                    fecha_colocacion: null,
                    notas: 'Carga masiva inicial'
                };

                try {
                    if (db) {
                        await db.collection('protesis').add(fullItem);
                        console.log(`‚úÖ Cargado: ${item.paciente}`);
                    }
                } catch (e) {
                    console.error(`‚ùå Error con ${item.paciente}:`, e);
                }
            }
            alert("Carga masiva finalizada. La p√°gina se recargar√°.");
            location.reload();
        }
    </script>

    <!-- Secci√≥n oculta para impresi√≥n -->
    <div id="section-to-print"></div>
</body>

</html>